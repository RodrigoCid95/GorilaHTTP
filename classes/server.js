"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.HTTPServer=void 0;var tslib_1=require("tslib"),express=require("express"),HTTP=require("http"),HTTPS=require("https"),Path=require("path"),bodyParser=require("body-parser"),gorila_core_1=require("gorila-core"),HTTPServer=function(){function e(e,t,r){this.configLoader=e,this.HTTPControllersDeclarations=t,this.lm=r,this.app=express(),this.ports={http:0,https:0},this.HTTPControllersInstances=[]}return e.prototype.init=function(){var e,t;return tslib_1.__awaiter(this,void 0,void 0,(function(){return tslib_1.__generator(this,(function(r){switch(r.label){case 0:return this.useLogger=null===(t=null===(e=this.configLoader.getConfig("GorilaHttp"))||void 0===e?void 0:e.dev)||void 0===t?void 0:t.logger,gorila_core_1.Log("Iniciando http server ...",this.useLogger),!this.lm||this.lm.isCompiled()?[3,2]:[4,this.lm.build()];case 1:r.sent(),r.label=2;case 2:return[4,this.runHTTPServer()];case 3:return r.sent(),[2]}}))}))},e.prototype.runHTTPServer=function(){var e,t,r,s,i;return tslib_1.__awaiter(this,void 0,void 0,(function(){var o,n,a,p,l,h,u,c,d,v=this;return tslib_1.__generator(this,(function(g){switch(g.label){case 0:for(gorila_core_1.Log("Instanciando Express ...",this.useLogger),o=this.configLoader.getConfig("GorilaHttp")||{},this.httpServer=o.http?HTTP.createServer(o.http,this.app):HTTP.createServer(this.app),this.isHttps=void 0!==o.https,this.isHttps&&(this.httpsServer=o.https?HTTPS.createServer(o.https,this.app):HTTPS.createServer(this.app)),(null===(e=null==o?void 0:o.dev)||void 0===e?void 0:e.showExternalIp)&&(n=require("os").networkInterfaces(),(null===(t=null==o?void 0:o.dev)||void 0===t?void 0:t.interfaceNetwork)?(a=n[o.dev.interfaceNetwork])?this.externalIp=a.find((function(e){return"IPv4"==e.family})).address:console.error('\nLa interfáz de red "'+o.dev.interfaceNetwork+'" no existe!.\nSe pueden usar las isguientes interfaces:\n'+Object.keys(n).join(", ")):console.error("\nNo se definió una interfaz de red.\nSe pueden usar las isguientes interfaces:\n"+Object.keys(n).join(", "))),(null===(r=null==o?void 0:o.events)||void 0===r?void 0:r.beforeConfig)&&(this.app=o.events.beforeConfig(this.app)),(null==o?void 0:o.pathsPublic)&&o.pathsPublic.forEach((function(e){var t=Path.normalize(e.dir);v.app.use(e.route,express.static(t))})),(null==o?void 0:o.ports)?this.ports.http=process.env.PORT?parseInt(process.env.PORT):o.ports.http||5e3:this.ports.http=process.env.PORT?parseInt(process.env.PORT):5e3,this.isHttps&&(this.ports.https=process.env.PORT?parseInt(process.env.PORT):o.ports&&o.ports.https||5001),this.app.use(bodyParser.json()),this.app.use(bodyParser.urlencoded({extended:!1})),(null===(s=null==o?void 0:o.events)||void 0===s?void 0:s.afterConfig)&&(this.app=o.events.afterConfig(this.app)),o.engineTemplates&&(this.app.engine(o.engineTemplates.ext,o.engineTemplates.callback),this.app.set("views",Path.normalize(o.engineTemplates.dirViews)),this.app.set("view engine",o.engineTemplates.name)),gorila_core_1.Log("Express instanciado!",this.useLogger),gorila_core_1.Log("Cargando controladores HTTP ...",this.useLogger),p=0,l=this.HTTPControllersDeclarations;p<l.length;p++)c=l[p],this.HTTPControllersInstances.push(new c(this.useLogger,this.lm));for(h=0,u=this.HTTPControllersInstances;h<u.length;h++)(c=u[h]).prefix?(d=c.prefix[0],"/"===c.prefix[c.prefix.length-1]&&c.prefix.pop(),"/"!==d&&(c.prefix="/"+c.prefix),this.app.use(c.prefix,c.router)):this.app.use(c.router),delete c.router;if(0===this.HTTPControllersInstances.length)throw new Error("No se encontraron controladores HTTP.");return gorila_core_1.Log("Controladores cargados!",this.useLogger),gorila_core_1.Log("Iniciando servidor",this.useLogger),(null===(i=null==o?void 0:o.events)||void 0===i?void 0:i.beforeStarting)&&o.events.beforeStarting(this.app),[4,new Promise((function(e){v.httpServer.listen(v.ports.http,(function(){return tslib_1.__awaiter(v,void 0,void 0,(function(){return tslib_1.__generator(this,(function(t){return this.isHttps?this.httpsServer.listen(this.ports.https,(function(){e()})):e(),[2]}))}))}))}))];case 1:return g.sent(),gorila_core_1.Log("Servidor iniciado en el puerto "+this.ports.http,this.useLogger),this.ports.https&&gorila_core_1.Log("Servidor HTTPS iniciado en el puerto "+this.ports.https,this.useLogger),[2]}}))}))},e}();exports.HTTPServer=HTTPServer;